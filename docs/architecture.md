# Architecture

## Scope
Fullstack pipeline with Bun + Fastify backend, n8n workflows, PostgreSQL persistence, and React frontend.

## End-to-end flow
1. Frontend calls backend `POST /users/execute`.
2. Backend fetches encrypted payload from secure endpoint.
3. Backend decrypts payload using AES-256-GCM.
4. Backend forwards decrypted users to n8n ingest webhook.
5. n8n writes users to PostgreSQL and returns persisted rows.
6. Frontend renders rows in a `<table>` without reloading.
7. Frontend `POST /users/clear` triggers n8n clear webhook (TRUNCATE) and clears table state.

## Secure endpoint details (validated)
- Endpoint URL: `https://n8n-apps.nlabshealth.com/webhook/data-5dYbrVSlMVJxfmco`
- Method: `GET`
- Response top-level keys: `success`, `data`
- Encryption metadata fields:
  - `data.algorithm`
  - `data.secretKey`
  - `data.encrypted.iv`
  - `data.encrypted.authTag`
  - `data.encrypted.encrypted`

## Encrypted payload contract
AES-256-GCM decryptor supports:
- nested secure-endpoint shape above
- flat fixture shape (`ciphertext`, `iv`, `authTag`, `key`)

### Encoding behavior
- auto-detects `hex` and `base64`
- validates 32-byte key length
- fail-closed on invalid auth tag/invalid payload

## User model and mapping
Expected user fields:
- `nome`
- `email`
- `phone`

Optional during pipeline:
- `id` generated by PostgreSQL.

## n8n webhooks behavior
- `ingest-users` (POST): receive decrypted users, persist to DB, return persisted users list.
- `list-users` (GET): return persisted users list.
- `clear-users` (POST): `TRUNCATE users` and return `{ cleared: true }`.

## PostgreSQL schema (exact spec)
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  nome VARCHAR(128) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20) NOT NULL
);
```

## Spec Checklist
- Backend in Node/Fastify with REST endpoints.
- AES-256-GCM decryption implemented in backend.
- Decrypted data forwarded to n8n webhook.
- n8n persists in PostgreSQL and returns persisted data.
- Frontend has `<table>` with users from pipeline.
- Frontend has `Executar` and `Limpar` buttons.
- UI updates dynamically without full page reload.
- Responsive layout for different devices.
- Cloud deployment for frontend and backend with public URLs.
