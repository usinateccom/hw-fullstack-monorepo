# Architecture

## Scope
Fullstack pipeline with Bun + Fastify backend, n8n workflows, PostgreSQL persistence, and React frontend.

## End-to-end flow
1. Frontend calls backend `POST /users/execute`.
2. Backend fetches encrypted payload from secure endpoint.
3. Backend decrypts payload using AES-256-GCM.
4. Backend forwards decrypted users to n8n ingest webhook.
5. n8n writes users to PostgreSQL and returns persisted rows.
6. Frontend renders rows in a `<table>` without reloading.
7. Frontend `POST /users/clear` triggers n8n clear webhook (TRUNCATE) and clears table state.

## Secure endpoint details (from spec)
- Endpoint URL: `https://n8n-apps.nlabshealth.com/webhook/data-5dYbrVSlMVJxfmco`
- Method: `GET` (assumption based on webhook-style data endpoint; validate during runtime)
- Response: encrypted data using AES-256-GCM.
- Spec note: response includes initialization vectors and secret keys for decryption.

## Encrypted payload contract
The PDF defines AES-256-GCM usage but does not publish exact JSON field names or encodings.

### Required fields expected by decryptor
- `ciphertext` (encrypted bytes)
- `iv` (initialization vector)
- `authTag` (authentication tag)
- `key` (256-bit key)

### Encoding assumptions
- Default parser strategy: try base64 first, then hex when needed.
- Decryptor must fail closed for invalid/missing fields or auth failure.

## User model and mapping
Expected user fields (spec DB contract):
- `nome`
- `email`
- `phone`

Optional during pipeline:
- `id` generated by PostgreSQL.

## n8n webhooks behavior
- `ingest-users` (POST): receive decrypted users, persist to DB, return persisted users list.
- `list-users` (GET): return persisted users list.
- `clear-users` (POST): `TRUNCATE users` and return `{ cleared: true }`.

## PostgreSQL schema (exact spec)
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  nome VARCHAR(128) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20) NOT NULL
);
```

## Spec Checklist
- Backend in Node/Fastify with REST endpoints.
- AES-256-GCM decryption implemented in backend.
- Decrypted data forwarded to n8n webhook.
- n8n persists in PostgreSQL and returns persisted data.
- Frontend has `<table>` with users from pipeline.
- Frontend has `Executar` and `Limpar` buttons.
- UI updates dynamically without full page reload.
- Responsive layout for different devices.
- Cloud deployment for frontend and backend with public URLs.

## Explicit assumptions
- Secure endpoint payload field names/encodings are inferred at runtime because PDF omits exact format.
- n8n webhook paths (`ingest-users`, `list-users`, `clear-users`) are implementation-defined for this repo.
- Local setup remains Docker-optional only.
